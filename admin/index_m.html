<html>

<head>

    <!-- Load ioBroker scripts and styles-->
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>

    <!-- Load our own files -->
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="words.js"></script>

    <script type="text/javascript">
        var secret = '';
        var credentials = false;

        // the function loadSettings has to exist ...
        function load(settings, onChange) {
            if (systemConfig) {
                secret = (systemConfig && systemConfig.native && systemConfig.native.secret) || '5Cd6dDqzq8bBbKJ9';
                loadHelper(settings, onChange);
                return;
            }
            socket.emit('getObject', 'system.config', function (err, obj) {
                secret = (obj.native ? obj.native.secret : '') || '5Cd6dDqzq8bBbKJ9';
                loadHelper(settings, onChange);
            });
        }
        // This will be called by the admin adapter when the settings page loads
        function loadHelper(settings, onChange) {
            if (!settings) return;

            if (settings.password && (typeof supportsFeature !== 'function' || !supportsFeature('ADAPTER_AUTO_DECRYPT_NATIVE'))) {
                settings.password = decrypt(secret, settings.password);
            }

            $('.value').each(function () {
                var $key = $(this);
                var id = $key.attr('id');
                if ($key.attr('type') === 'checkbox') {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.prop('checked', settings[id])
                        .on('change', () => onChange());
                } else {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.val(settings[id])
                        .on('change', () => onChange())
                        .on('keyup', () => onChange());
                }
            });

            function checkButtonState(){
                var email = $("#email").val().trim(),password=$("#password").val().trim();
                if(email.length && password.length && email.match(/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/g)){
                    $(".btn-login-test").removeClass("disabled");
                    $(".btn-login-test").addClass("active");
                    clickButtonAction();
                } else {
                    $(".btn-login-test").addClass("disabled");
                    $(".btn-login-test").removeClass("active");
                    clickButtonAction();
                }
            }

            function clickButtonAction(){
                $(".btn-login-test").unbind();
                $(".btn-login-test.active").on("click", function(){
                    var email = $("#email").val().trim(),password=$("#password").val().trim();
                    $.ajax({
                        url: 'https://backend.powerfox.energy/api/2.0/my/all/devices',
                        type: 'GET',
                        dataType: 'json',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader ("Authorization", "Basic " + btoa(email + ":" + password));
                            $(".login-test-state .material-icons").removeClass("success").removeClass("error").addClass("sync").text("sync");
                        },
                        success: function(data) {
                            if(data.hasOwnProperty("message")){
                                $(".login-test-state .material-icons").removeClass("success").removeClass("sync").addClass("error").text("cancel");
                                console.log(data.message);
                            } else {
                                $(".login-test-state .material-icons").removeClass("error").removeClass("sync").addClass("success").text("check_circle");
                                credentials = true;
                            }
                        },
                        error: function(request,error) {
                            $(".login-test-state .material-icons").removeClass("success").removeClass("sync").addClass("error").text("sync_problem");
                        }
                    });
                });
            }

            checkButtonState();

            onChange(false);
            // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
            if (M) M.updateTextFields();

        }

        // This will be called by the admin adapter when the user presses the save button
        function save(callback) {
            // example: select elements with class=value and build settings object
            var obj = {};
            $('.value').each(function () {
                var $this = $(this);
                if ($this.attr('type') === 'checkbox') {
                    obj[$this.attr('id')] = $this.prop('checked');
                } else {
                    obj[$this.attr('id')] = $this.val();
                }
            });
            callback(obj);
        }
    </script>

</head>

<body>
    <div class="m adapter-container">
        <div class="row">
            <div class="col s11 m4 l2">
                <img src="powerfox.png" class="logo">
                <div class="preloader-background" style="display: none;">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s3">
                <input class="value autocomplete" id="email" type="text" autocomplete="off">
                <label class="translate active">email</label>
            </div>
            <div class="input-field col s3">
                <input class="value autocomplete" id="password" type="text" autocomplete="off">
                <label class="translate active">password</label>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s6">
                <a class="btn btn-active btn-login-test disabled"><i class="material-icons left">cast</i><span class="translate" data-lang="credentials-test">Login testen</span></a>
                <span class="login-test-state" style="display: none;"><i class="material-icons">check_circle</i></span>
            </div>
        </div>
    </div>
</body>
</html>